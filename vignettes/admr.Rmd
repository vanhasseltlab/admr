---
title: "Get started with admr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with admr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

# Example of using `admr` with `rxode2`

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Import the `admr` and other packages:

```{r setup, message = FALSE, warning = FALSE}
library(admr)
library(rxode2)
library(nlmixr2)
library(dplyr)
library(tidyr)
library(mnorm)
```

```{r, cache=TRUE}
head(examplomycin)
```

In this scenario, we will use the `examplomycin` dataset to demonstrate how to use the `admr` package with the `rxode2` package.
We show how to manipulate the dataset to get it in the right format for the `admr` package.
In future scenarios, we might not have access to an individual dataset, but this vignette demonstrates the right format.

```{r, cache=TRUE}
examplomycin_wide <- examplomycin %>%
  filter(EVID != 101) %>%
  dplyr::select(ID, TIME, DV) %>%  # Select only the relevant columns
  pivot_wider(names_from = TIME, values_from = DV) %>%
  dplyr::select(-c(1))

examplomycin_aggregated <- examplomycin_wide %>%
  admr::meancov()

head(examplomycin_aggregated)
```

## Defining the RxODE model

We will define a two-compartment model for the examplomycin dataset.
The model has the following differential equations:

```{r, message = FALSE, warning = FALSE}
rxModel <- RxODE({
  # Parameters
  ke = cl / v1             # Elimination rate constant
  k12 = q / v1             # Rate constant for central to peripheral transfer
  k21 = q / v2             # Rate constant for peripheral to central transfer
  
  # Differential equations for drug amount in compartments
  d/dt(depot)    = -ka * depot
  d/dt(central)  = ka * depot - ke * central - k12 * central + k21 * peripheral
  d/dt(peripheral) = k12 * central - k21 * peripheral
  
  # Concentration in the central compartment
  cp = central / v1
})
```

A solved model is available for the two-compartment model, speeding up the simulation process.
The `linCmt` function has multiple solved models.
The function takes the following arguments:

```{r, message = FALSE, warning = FALSE}
rxModel <- RxODE({
  cp = linCmt(    # Solved one- or two-compartment model
    cl,           # Clearance
    v1,           # Volume of the central compartment
    v2,           # Volume of the peripheral compartment
    q,            # Inter-compartmental clearance
    ka            # Absorption rate constant
  )
})
```

## Defining the prediction function

This is necessary for the `admr` package to simulate the model.
Tt constructs the event table for dosing and sampling, solves the RxODE model, and extracts the predicted concentrations.
The function can handle both single and multiple individuals.
```{r, cache=TRUE}
predder <- function(time, theta_i, dose = 100) {
    n_individuals <- nrow(theta_i)
    
    if (is.null(n_individuals)) {
      n_individuals <- 1
    }

    # Create the event table for dosing and sampling
    ev <- eventTable(amount.units="mg", time.units="hours")
    ev$add.dosing(dose = dose, nbr.doses = 1, start.time = 0)  # Assume same dose
    ev$add.sampling(time)  # Time points to simulate
    
    # Solve the RxODE model for all individuals
    out <- rxSolve(rxModel, params = theta_i, events = ev, cores = 0)
    
    # Extract the predicted concentrations (cp) and format them as a matrix
    cp_matrix <- matrix(out$cp, nrow = n_individuals, ncol = length(time), 
                        byrow = TRUE)
    
    # Return matrix of predicted concentrations
    return(cp_matrix)
}
```

This opts object contains the options for the `admr` package.
The `genopts` function generates the options object.
Here the parameters are:
1.  time:
    -   A vector of time points for sampling predictions in the model.
    -   These are the observation times at which the model predictions are evaluated.
    -   Example: c(.1, .25, .5, 1, 2, 3, 5, 8, 12).
2.  p:
    -   Values for the population parameters (beta) and their covariance matrix (Omega).

    -   These are either the initial values for the optimization or the true values for simulation.

    -   Example: list(beta = c(cl = 5, v1 = 10, v2 = 30, q = 10, ka = 1), Omega = omegas(.09, 0, 5)).
3.  nsim:
    -   Number of Monte Carlo samples per iteration.

    -   Higher values improve accuracy but increase computation time.

    -   Example: 2500.
4.  n:
    -   Number of individuals in the dataset.

    -   This is used for the Objective Function Value (OFV), AIC, and BIC calculation.

    -   Example: 500.
5.  fo_appr:
    -   Enabling the First-Order Approximation method for parameter estimation.
6.  omega_expansion:
    -   Factor by which the covariance matrix (Omega) is expanded during estimation to account for uncertainty.

    -   Example: 2 doubles the covariance matrix values temporarily during sampling.
7.  f:
    -   The prediction function that simulates model outputs based on individual parameters.

    -   Example: predder, as specified above.
  
```{r, cache=TRUE}
opts <- genopts(time=c(.1,.25,.5,1,2,3,5,8,12),
                  p=list(beta=c(cl = 5, v1 = 10, v2 = 30,q = 10, ka = 1),
                  Omega=omegas(.09,0,5),Sigma_prop=0.04),
                  nsim=2500,n=500, fo_appr=F, omega_expansion=1.2,
                  f=predder)
```

The `fitEM` function fits the model to the dataset.
It takes the following arguments:
```{r, cache=TRUE}
fit.admr <- admr::fitEM(opts, examplomycin_aggregated, chains = 3)
```

This is the output of the `fitEM` function.
```{r}
print(fit.admr)
```

The `plot` function can be used to visualize the results.
It shows the convergence of the model fit and parameters by making a trace plot of the chains.
```{r}
plot(fit.admr)
```
