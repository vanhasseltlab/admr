---
title: "examplomycin"
output: html_document
---
# Creating the examplomycin dataset
In this vignette we will create a simulated dataset for a fictional drug called examplomycin. The dataset will contain 25 subjects with 9 timepoints each. The data will be generated using a two-compartment model with first-order absorption and elimination. The model parameters will be sampled from a multivariate normal distribution with a specified covariance matrix. The dataset will also include a random error term to simulate measurement noise. We make the dataset available as a data object in the package for use in other vignettes.

## Libraries
We will use the following libraries to generate the data and plot the results:
```{r library import, message = FALSE, warning = FALSE}
library(rxode2)
library(MASS)
library(ggplot2)
library(nlmixr2)
library(parallel)
library(data.table)
library(dplyr)
library(ggplot2)
```

## Data generating function
This function generates the examplomycin dataset. It takes three arguments: `n` (number of subjects), `times` (vector of timepoints), and `seed` (random seed for reproducibility). The function first defines the two-compartment model using the `RxODE` function. It then generates the model parameters by sampling from a multivariate normal distribution with a specified covariance matrix. The function also generates the event table for the simulation, including a single dose of 100 units at time 0 and observations at the specified timepoints. The model is solved using the `rxSolve` function, and the simulated data is stored in a data frame. The function returns the simulated dataset.
```{r data generating function}
generate_data <- function(n, times, seed = 1) {
  set.seed(seed)
  
  mod <- RxODE({
    # Parameters
    ke = cl / v1             # Elimination rate constant
    k12 = q / v1             # Rate constant for central to peripheral transfer
    k21 = q / v2             # Rate constant for peripheral to central transfer
    
    # Differential equations for drug amount in compartments
    d/dt(depot)    = -ka * depot
    d/dt(central)  = ka * depot - ke * central - k12 * central + k21 * peripheral
    d/dt(peripheral) = k12 * central - k21 * peripheral
    
    # Concentration in the central compartment
    cp = central / v1
  })

  # Generate covariates
  theta <- c(cl=5, v1 = 10, v2 =30, q =10, ka = 1)

  omegaCor <- matrix(c(1,  0,  0,  0,  0,
                       0,  1,  0,  0,  0,
                       0,  0,  1,  0,  0,
                       0,  0,  0,  1,  0,
                       0,  0,  0,  0,  1), dimnames=list(NULL,c("eta.cl","eta.v1","eta.v2", "eta.q", "eta.ka")), nrow=5)

  iiv.sd <- c(0.3, 0.3, 0.3, 0.3, 0.3) ## SDs of model parameters

  iiv <- iiv.sd %*% t(iiv.sd)
  omega <- iiv * omegaCor  # covariance matrix

  mv <- mvrnorm(n, rep(0, dim(omega)[1]), omega)

  params.all <-
    data.table(
      "ID" = seq(1:n),
      "cl" = theta['cl'] * exp(mv[, 1]),
      "v1" = theta['v1'] * exp(mv[, 2]),
      "v2" = theta['v2'] * exp(mv[, 3]),
      "q"  = theta['q']  * exp(mv[, 4]),
      "ka" = theta['ka'] * exp(mv[, 5])
    )

  # Event table
  ev <- et() %>%
    et(amt = 100) %>%  # Add single dose
    et(0) %>%  # Add initial time observation
    et(times) %>%  # Sampling schedule
    et(ID = seq(1, n)) %>%  # Assign unique IDs for all subjects
    as.data.frame()

  # Solve the model
  sim <- rxSolve(mod, events = ev, iCov = params.all, cores = 0, addCov = T) %>%
    mutate(ID = as.integer(id), TIME = as.numeric(time)) %>%
    dplyr::select(-c(id, time)) %>%
    mutate(AMT =  ifelse(TIME == 0, 100, 0)) %>%
    mutate(EVID = ifelse(TIME == 0, 101, 0)) %>%
    mutate(CMT = ifelse(TIME == 0, 1, 2))

  # Simulate residual error and combine
  sim$rv <- rnorm(nrow(sim), 0, 0.1)
  sim$DV <- round(sim$cp * (1 + sim$rv), 3)
  sim <- merge(sim, params.all)

  dat <- sim %>%
    dplyr::select("ID", "TIME", "DV", "AMT", "EVID", "CMT")

  return(dat)
}
```

## Generating the examplomycin dataset
We will now generate the examplomycin dataset with 25 subjects and 9 timepoints each. We will use a random seed of 1 for reproducibility.
```{r examplomycin data}
examplomycin <- generate_data(n = 25, times = c(0.5, 1, 2, 3, 4, 6, 8, 12, 24), seed = 1)
head(examplomycin)
```
```{r saving data, include=FALSE}
usethis::use_data(examplomycin, overwrite = TRUE)
```

## Plotting the examplomycin dataset
We will now create a concentration-time plot of the examplomycin dataset. Each line represents a different subject, and the points represent the observed concentrations at each timepoint. The color of the lines corresponds to the subject ID.
```{r plot output, fig.alt="Line plot of examplomycin concentration over time."}
# Basic concentration-time plot
ggplot(examplomycin, aes(x = TIME, y = DV, color = factor(ID))) +
  geom_line(alpha = 0.7) +    # Lines connecting points
  geom_point(size = 2, alpha = 0.8) +  # Points for observations
  scale_color_viridis_d(name = "Subject ID") +  # Color by subject ID
  labs(
    title = "Concentration-Time Profile",
    x = "Time (hours)",
    y = "Observed Concentration (DV)"
  ) + # y log scale
  theme_minimal() +
  theme(legend.position = "none")  # Hide legend if too many subjects


```

